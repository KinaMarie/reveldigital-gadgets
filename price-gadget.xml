<?xml version="1.0" encoding="UTF-8" ?> 
<Module> 
<ModulePrefs title="RevelDigital Price Gadget" description="Gets and displays a price" author="RevelDigital" background="transparent">
  <UserPref name="apikey" display_name="Api Key" datatype="string" />
   <UserPref name="deviceId" display_name="Device Name Tag" datatype="string" />
  <UserPref name="gadgetKey" display_name="Gadget Key" datatype="string" />
  <UserPref name="price-style" display_name="Price Style" datatype="style" default_value="font-family:Verdana;color:rgb(0, 0, 0);font-size:24px;" required="true" />
  <UserPref name="gadgetWidth" display_name="Width" required="true" default_value="100" datatype="hidden" />
  <UserPref name="gadgetHeight" display_name="Height" required="true" default_value="100" datatype="hidden" />
</ModulePrefs>
<Content type="html">
<![CDATA[
<script src="https://code.jquery.com/jquery-1.11.0.min.js"></script>
<style type="text/css">

	body {
		background: transparent;
	}
	
	#priceContainer {
		__UP_price-style__
	}
</style>

<body>
	<p id="priceContainer"></p>
</body>

<script type="text/javascript">
		var groupName = "default";
		var prefs = new gadgets.Prefs();
		
		function init() {
			console.log('Resolved Api Key ' + prefs.getString("apikey"));
			console.log('Resolved Device Name ' + prefs.getString("deviceId"));
			console.log('Resolved Gadget Key ' + prefs.getString("gadgetKey"));
			$.getJSON("https://api.reveldigital.com/devices.json?api_key=" + prefs.getString("apikey"), function (data) {
				$.each(data, function (index, item) {
				console.log('Item  ' + item.name);
				if (item.name.toLowerCase() == prefs.getString("deviceId").toLowerCase()) {
					groupName = item.group_name;
				}
			  });
			}).done(function() {
			  requestPrice(groupName);
			});
		}
		  
		gadgets.util.registerOnLoadHandler(init);
		
		function requestPrice(store) {
			console.log('Resolved Device Group Name ' + store);
			var price = "N/A";
			var proxy = 'https://as1.reveldigital.com/Proxy?url='
			var root = 'http://msg.reveldigital.com/Api/RequestPrice';
			var full = root + '?storeId=' + store + '&gadgetKey=' + prefs.getString("gadgetKey");
			console.log('Before encoding ' + full);
			var encoded = encodeURIComponent(full);
			console.log('AFter encoding ' + encoded);
			$.getJSON(proxy + encoded , function (data) {
				$.each(data, function (value) {
					console.log('Value returned by API ' + value);
					price = value;
			  });
			}).done(function() {
			  setPrice(price);
			});
		}
		  
		function setPrice(data) {
			var container = $('#priceContainer');
			container.text(data);
		}
</script>]]>
</Content>
</Module>